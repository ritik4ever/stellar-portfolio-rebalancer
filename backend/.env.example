# ============================================
# STELLAR PORTFOLIO REBALANCER - BACKEND ENV
# ============================================

# Server Configuration
NODE_ENV=development
PORT=3001

# ============================================
# DATABASE CONFIGURATION
# ============================================

# PostgreSQL connection string
DATABASE_URL=postgresql://user:password@localhost:5432/stellar_portfolio

# ============================================
# STELLAR NETWORK CONFIGURATION
# ============================================

# Network: testnet or mainnet
STELLAR_NETWORK=testnet

# REQUIRED: Stellar Horizon API URL
STELLAR_HORIZON_URL=https://horizon-testnet.stellar.org

# REQUIRED: Contract Address (deployed on selected Stellar network)
# Replace with your actual deployed contract address (Soroban contract strkey starting with C)
STELLAR_CONTRACT_ADDRESS=CDEMOCONTRACTADDRESS123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ

# REQUIRED: Secret used by backend to sign DEX rebalance transactions.
# Use a testnet account secret only in development.
STELLAR_REBALANCE_SECRET=

# Allow signer account mismatch with portfolio user address (not recommended)
REBALANCE_ALLOW_SIGNER_MISMATCH=false

# Optional JSON map for non-native assets used in rebalancing
# Example: {"USDC":"G...","BTC":"G...","ETH":"G..."}
STELLAR_ASSET_ISSUERS={"USDC":"GBBD47IF6LWK7P7MDEVSCWR7DPUWV3NY3DTQEVFL4NAT4AQH3ZLLFLA5","BTC":"GAUTUYY2THLF7SGITDFMXJVYH3LHDSMGEAKSBU267M2K7A3W543CKUEF"}

# ============================================
# PRICE FEED CONFIGURATION
# ============================================

# CoinGecko API Configuration
# Get your API key from: https://www.coingecko.com/en/api/pricing
COINGECKO_API_KEY=

# Price cache duration (milliseconds)
PRICE_CACHE_DURATION=300000

# Minimum request interval (milliseconds)
MIN_REQUEST_INTERVAL=90000

# ============================================
# AUTO-REBALANCER CONFIGURATION
# ============================================

# Enable automatic rebalancing service
ENABLE_AUTO_REBALANCER=false

# Check interval (milliseconds) - 1 hour
AUTO_REBALANCE_CHECK_INTERVAL=3600000

# Minimum time between rebalances (milliseconds) - 24 hours
MIN_REBALANCE_INTERVAL=86400000

# Maximum auto-rebalances per day per portfolio
MAX_AUTO_REBALANCES_PER_DAY=3

# ============================================
# RATE LIMITING CONFIGURATION
# ============================================

# Global rate limiting (applies to all requests)
RATE_LIMIT_WINDOW_MS=60000
RATE_LIMIT_MAX=100

# Write operations rate limiting (POST/PUT/DELETE)
RATE_LIMIT_WRITE_MAX=10

# Authentication endpoints rate limiting
RATE_LIMIT_AUTH_MAX=5

# Critical operations rate limiting (rebalancing, data deletion)
RATE_LIMIT_CRITICAL_MAX=3

# Burst protection (short window, prevents rapid-fire attacks)
RATE_LIMIT_BURST_WINDOW_MS=10000
RATE_LIMIT_BURST_MAX=20
RATE_LIMIT_WRITE_BURST_MAX=3

# ============================================
# JOB QUEUE CONFIGURATION (BullMQ + Redis)
# ============================================

# Redis connection URL for BullMQ durable job queue (issue #38)
# Format: redis://[user:password@]host[:port][/db]
# Defaults to redis://localhost:6379 if not set
# Required for production â€“ when unset, queue-backed scheduling is skipped gracefully
REDIS_URL=redis://localhost:6379

# ============================================
# CIRCUIT BREAKER CONFIGURATION
# ============================================

# Volatility threshold (percentage)
VOLATILITY_THRESHOLD=15

# Price data max age (seconds)
PRICE_DATA_MAX_AGE=600

# Cooldown period (hours)
REBALANCE_COOLDOWN_HOURS=1

# Maximum single asset concentration (percentage)
MAX_SINGLE_ASSET_CONCENTRATION=80

# Maximum trade size (percentage of portfolio)
MAX_TRADE_SIZE_PERCENTAGE=25

# Minimum trade size (USD)
MIN_TRADE_SIZE_USD=10

# Rebalance execution safety controls
REBALANCE_MAX_TRADE_SLIPPAGE_BPS=100
REBALANCE_MAX_TOTAL_SLIPPAGE_BPS=250
REBALANCE_MAX_SPREAD_BPS=120
REBALANCE_MIN_LIQUIDITY_COVERAGE=1.0
REBALANCE_ALLOW_PARTIAL_FILL=true
REBALANCE_ROLLBACK_ON_FAILURE=true

# ============================================
# NOTIFICATION CONFIGURATION
# ============================================

# Email Notifications (using Nodemailer)
# SMTP Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
SMTP_FROM=noreply@stellarportfolio.com

# Webhook Configuration
WEBHOOK_TIMEOUT=5000
WEBHOOK_RETRY_COUNT=1
WEBHOOK_RETRY_DELAY=1000

# Notification Rate Limiting
NOTIFICATION_RATE_LIMIT_PER_HOUR=10

# ============================================
# CORS CONFIGURATION
# ============================================

# Allowed origins (comma-separated)
CORS_ORIGINS=http://localhost:3000,http://localhost:5173,http://127.0.0.1:3000

# ============================================
# LOGGING CONFIGURATION
# ============================================

# Log level: debug, info, warn, error
LOG_LEVEL=info

# Enable detailed API logging
ENABLE_API_LOGGING=true

# Enable price feed debugging
DEBUG_PRICE_FEEDS=false

# ============================================
# WEBSOCKET CONFIGURATION
# ============================================

# WebSocket server port (uses same as HTTP if not specified)
WS_PORT=3001

# WebSocket heartbeat interval (milliseconds)
WS_HEARTBEAT_INTERVAL=30000

# ============================================
# RISK MANAGEMENT CONFIGURATION
# ============================================

# Risk thresholds
RISK_VOLATILITY_HIGH=10
RISK_VOLATILITY_CRITICAL=15
RISK_CONCENTRATION_HIGH=60
RISK_CONCENTRATION_CRITICAL=80
RISK_LIQUIDITY_LOW=1000
RISK_LIQUIDITY_CRITICAL=500

# ============================================
# ANALYTICS CONFIGURATION
# ============================================

# Snapshot capture interval (milliseconds) - 5 minutes
ANALYTICS_SNAPSHOT_INTERVAL=300000

# Maximum snapshots to keep per portfolio
MAX_SNAPSHOTS_PER_PORTFOLIO=1000

# ============================================
# SECURITY CONFIGURATION
# ============================================

# JWT Authentication (required for token-based auth)
JWT_SECRET=your-secret-key-min-32-chars-change-in-production
JWT_ACCESS_EXPIRY_SEC=900
JWT_REFRESH_EXPIRY_SEC=604800

# API rate limiting
API_RATE_LIMIT_WINDOW=900000
API_RATE_LIMIT_MAX_REQUESTS=100

# Request timeout (milliseconds)
REQUEST_TIMEOUT=30000

# Enable request validation
ENABLE_REQUEST_VALIDATION=true

# ============================================
# DEVELOPMENT/DEBUG SETTINGS
# ============================================

# Feature Flags
# In production, defaults are strict if unset:
#   DEMO_MODE=false
#   ALLOW_FALLBACK_PRICES=false
#   ENABLE_DEBUG_ROUTES=false

# Enable demo mode (simulated portfolio creation paths)
DEMO_MODE=true

# Allow fallback market prices when external sources fail
ALLOW_FALLBACK_PRICES=true

# Allow mock/generated price history when market history APIs fail
ALLOW_MOCK_PRICE_HISTORY=true

# Allow debug and test endpoints (/debug/* and /test/*)
ENABLE_DEBUG_ROUTES=true

# Allow demo balances when on-chain balance fetch fails
ALLOW_DEMO_BALANCE_FALLBACK=true

# Seed demo portfolio/history into DB on first run
ENABLE_DEMO_DB_SEED=true

# Demo portfolio initial balance (USD)
DEMO_INITIAL_BALANCE=10000

# Mock external API calls (for testing)
MOCK_EXTERNAL_APIS=false

# ============================================
# PRODUCTION SETTINGS (uncomment for production)
# ============================================

# NODE_ENV=production
# DEMO_MODE=false
# ALLOW_FALLBACK_PRICES=false
# ALLOW_MOCK_PRICE_HISTORY=false
# ENABLE_DEBUG_ROUTES=false
# ALLOW_DEMO_BALANCE_FALLBACK=false
# ENABLE_DEMO_DB_SEED=false
# LOG_LEVEL=warn
# DEBUG_PRICE_FEEDS=false
# ENABLE_AUTO_REBALANCER=true

# ============================================
# NOTES
# ============================================

# 1. Database:
#    - PostgreSQL is required for this application
#    - Create database: createdb stellar_portfolio
#    - Run migrations: npm run db:migrate

# 2. CoinGecko API Key:
#    - Free tier: 10-50 calls/minute
#    - Pro tier: Higher limits, required for production
#    - Get key at: https://www.coingecko.com/en/api/pricing

# 3. Email Configuration (SMTP):
#    - For Gmail: Use App Password (not regular password)
#      1. Enable 2FA on your Google account
#      2. Go to: https://myaccount.google.com/apppasswords
#      3. Generate an app password for "Mail"
#      4. Use that password in SMTP_PASS
#    - For production: Use SendGrid, AWS SES, Mailgun, or similar service
#    - Alternative providers:
#      * SendGrid: smtp.sendgrid.net (port 587)
#      * Mailgun: smtp.mailgun.org (port 587)
#      * AWS SES: email-smtp.region.amazonaws.com (port 587)

# 4. Stellar Network:
#    - Use testnet for development
#    - Switch to mainnet for production
#    - Deploy contract and update STELLAR_CONTRACT_ADDRESS

# 5. Security:
#    - Never commit this file with real credentials
#    - Use environment-specific .env files
#    - Rotate API keys regularly
#    - Use strong passwords for SMTP

# 6. Auto-Rebalancer:
#    - Disabled by default for safety
#    - Enable only after thorough testing
#    - Monitor closely in production

# 7. Notifications:
#    - Test email configuration using POST /api/notifications/test
#    - Webhook notifications require HTTPS in production
#    - Configure notification preferences per user via API
